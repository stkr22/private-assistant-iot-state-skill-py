version: "3.8"

services:
  # Development container service
  dev:
    image: ghcr.io/stkr22/devcontainer-python-container:1.4.0@sha256:8830e371adfceaf5c17f8fa261aafea899fbcf940a0b72b76b005500a5279b99
    container_name: iot-state-skill-dev
    userns_mode: "keep-id"  # Podman: keeps your host UID
    working_dir: /workspace/private-assistant-iot-state-skill-py
    volumes:
      - ..:/workspace/private-assistant-iot-state-skill-py:rw,rprivate,rbind
    command: sleep infinity
    cap_add:
      - NET_RAW
    environment:
      # PostgreSQL connection (Assistant database)
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: assistant
      POSTGRES_PASSWORD: assistant_dev_password
      POSTGRES_DB: assistant
      # TimescaleDB connection (IoT data)
      IOT_POSTGRES_HOST: timescaledb
      IOT_POSTGRES_PORT: 5432
      IOT_POSTGRES_USER: iot_user
      IOT_POSTGRES_PASSWORD: iot_dev_password
      IOT_POSTGRES_DB: iot_data
      # MQTT connection
      MQTT_SERVER_HOST: mosquitto
      MQTT_SERVER_PORT: 1883
    depends_on:
      postgres:
        condition: service_healthy
      timescaledb:
        condition: service_healthy
      mosquitto:
        condition: service_healthy
    networks:
      - pa-iot-state-skill-network

  # PostgreSQL database for device registry
  postgres:
    image: docker.io/postgres:18.1-trixie@sha256:5773fe724c49c42a7a9ca70202e11e1dff21fb7235b335a73f39297d200b73a2
    container_name: iot-state-skill-postgres
    environment:
      POSTGRES_USER: assistant
      POSTGRES_PASSWORD: assistant_dev_password
      POSTGRES_DB: assistant
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U assistant -d assistant"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - pa-iot-state-skill-network

  # TimescaleDB for IoT data storage
  timescaledb:
    image: docker.io/timescale/timescaledb:2.25.0-pg17@sha256:1472440beade43e9042bc4ce3ba89dc026f7023b2133fda10946fde9f4a204cf
    container_name: iot-state-skill-timescaledb
    environment:
      POSTGRES_USER: iot_user
      POSTGRES_PASSWORD: iot_dev_password
      POSTGRES_DB: iot_data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U iot_user -d iot_data"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - pa-iot-state-skill-network

  # Eclipse Mosquitto MQTT broker
  mosquitto:
    image: docker.io/eclipse-mosquitto:2.0.22@sha256:e011726bdfa757011bc8b8716e03b7c35d2c3f623d9f658c2c6bf66e909ea42e
    container_name: iot-state-skill-mosquitto
    volumes:
      - ./config/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
    healthcheck:
      test: ["CMD-SHELL", "mosquitto_sub -t '$$SYS/#' -C 1 -i healthcheck -W 3"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - pa-iot-state-skill-network

networks:
  pa-iot-state-skill-network:
    driver: bridge
